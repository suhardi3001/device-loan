<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Loan System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
        .nav-tabs { margin-bottom: 20px; }
        #loading { display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; text-align: center; padding-top: 200px; }
        .modal-header-danger { background-color: #dc3545; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-center">Device Loan System</h2>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#loan">Loan</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#return">Return</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin">Admin</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="loan">
            <form id="loanForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>User Name</label>
                        <input class="form-control" list="userList" id="userName" required placeholder="Search...">
                        <datalist id="userList"></datalist>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Device</label>
                        <select class="form-select" id="deviceSelect" required><option disabled selected>Loading...</option></select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label>Start</label><input type="date" class="form-control" id="startDate" required></div>
                    <div class="col-md-6 mb-3"><label>End</label><input type="date" class="form-control" id="endDate" required></div>
                </div>
                <div class="mb-3">
                    <label>Context</label>
                    <select class="form-select" id="usageType"><option>Internal Use</option><option>Outside Use</option></select>
                </div>
                <div class="mb-3"><label>Details</label><textarea class="form-control" id="usageDetails"></textarea></div>
                <button type="button" onclick="submitLoan()" class="btn btn-primary w-100">Submit Loan</button>
            </form>
        </div>

        <div class="tab-pane fade" id="return">
            <div class="card bg-light border-primary p-3">
                <h5>Return Device</h5>
                <select class="form-select mb-3" id="returnSelect"><option disabled selected>Loading...</option></select>
                <button onclick="submitReturn()" class="btn btn-success w-100">Confirm Return</button>
            </div>
        </div>

        <div class="tab-pane fade" id="admin">
            <div id="loginPanel" class="text-center">
                <h4>Admin Login</h4>
                <div class="input-group mb-3">
                    <input type="password" id="adminPass" class="form-control" placeholder="Password">
                    <button class="btn btn-dark" onclick="verifyAdmin()">Unlock</button>
                </div>
            </div>
            <div id="adminPanel" style="display:none;">
                <div class="d-flex justify-content-between mb-3"><h5 class="text-success">Logged In</h5><button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">Lock</button></div>
                <div class="row g-2">
                    <div class="col-md-6 p-2 border rounded">
                        <h6>Add User</h6>
                        <input id="newUserName" class="form-control mb-2" placeholder="Name">
                        <button onclick="addUser()" class="btn btn-sm btn-secondary w-100">Add</button>
                    </div>
                    <div class="col-md-6 p-2 border rounded">
                        <h6>Add Device</h6>
                        <input id="newTag" class="form-control mb-1" placeholder="Tag">
                        <select id="newType" class="form-select mb-1"><option>Notebook</option><option>Projector</option><option>HDMI Cable</option><option>Webcam</option></select>
                        <input id="newSerial" class="form-control mb-1" placeholder="Serial">
                        <button onclick="addDevice()" class="btn btn-sm btn-secondary w-100">Add</button>
                    </div>
                </div>
                <hr>
                <button class="btn btn-danger w-100" onclick="resetAll()">âš  RESET SYSTEM</button>
            </div>
        </div>
    </div>
</div>

<div id="loading"><div class="spinner-border text-primary"></div><br>Processing...</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // *** PASTE YOUR DEPLOYMENT URL HERE ***
    const API_URL = "https://script.google.com/macros/s/AKfycbzm1Dwo6NSbMSs1nZT4K51J09UWff7QjriM93mYOpR8RUTReLEB5UwvjdvKmNiNvh8LZQ/exec";
    
    let sessionPass = "";

    window.onload = loadData;

    async function loadData() {
        try {
            const res = await fetch(API_URL + "?action=getData");
            const data = await res.json();
            
            // Populate Users
            const uList = document.getElementById('userList');
            uList.innerHTML = '';
            data.users.forEach(u => {
                let opt = document.createElement('option'); opt.value = u; uList.appendChild(opt);
            });

            // Populate Available
            const dSel = document.getElementById('deviceSelect');
            dSel.innerHTML = '<option disabled selected>Select Device...</option>';
            data.inventory.forEach(d => {
                let opt = document.createElement('option');
                opt.value = d[0]; opt.text = `${d[0]} | ${d[2]} | ${d[1]}`;
                dSel.appendChild(opt);
            });

            // Populate Returns
            const rSel = document.getElementById('returnSelect');
            rSel.innerHTML = '<option disabled selected>Select Device to Return...</option>';
            data.loaned.forEach(d => {
                let opt = document.createElement('option');
                opt.value = d[0]; opt.text = `${d[0]} | ${d[2]} | ${d[1]}`;
                rSel.appendChild(opt);
            });
        } catch (e) { alert("Connection Error: " + e); }
    }

// REPLACE YOUR EXISTING postData FUNCTION WITH THIS
    async function postData(payload) {
        document.getElementById('loading').style.display = 'block';
        
        try {
            // We use 'no-cors' trickery by sending plain text
            // This prevents the browser from doing a security "Preflight" check
            const res = await fetch(API_URL, {
                method: "POST",
                redirect: "follow", // Handle Google's 302 redirects
                headers: {
                    "Content-Type": "text/plain;charset=utf-8", // Force plain text
                },
                body: JSON.stringify(payload)
            });

            const json = await res.json();
            document.getElementById('loading').style.display = 'none';
            return json;

        } catch (error) {
            document.getElementById('loading').style.display = 'none';
            alert("Error: " + error);
            console.error(error);
            return { status: "error", message: error };
        }
    }

    async function submitLoan() {
        const payload = {
            action: 'submitLoan',
            userName: document.getElementById('userName').value,
            deviceSelect: document.getElementById('deviceSelect').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            usageType: document.getElementById('usageType').value,
            usageDetails: document.getElementById('usageDetails').value
        };
        const res = await postData(payload);
        alert(res.message);
        loadData();
    }

    async function submitReturn() {
        const payload = { action: 'processReturn', assetTag: document.getElementById('returnSelect').value };
        const res = await postData(payload);
        alert(res.message);
        loadData();
    }

    async function verifyAdmin() {
        const pass = document.getElementById('adminPass').value;
        const res = await postData({ action: 'adminVerify', password: pass });
        if(res.valid) {
            sessionPass = pass;
            document.getElementById('loginPanel').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
        } else {
            alert("Wrong Password");
        }
    }

    async function addUser() {
        const name = document.getElementById('newUserName').value;
        const res = await postData({ action: 'addUser', name: name, password: sessionPass });
        alert(res.message);
        loadData();
    }

    async function addDevice() {
        const tag = document.getElementById('newTag').value;
        const type = document.getElementById('newType').value;
        const serial = document.getElementById('newSerial').value;
        const res = await postData({ action: 'addDevice', tag: tag, type: type, serial: serial, password: sessionPass });
        alert(res.message);
        loadData();
    }

    async function resetAll() {
        if(!confirm("Are you sure? This resets everything.")) return;
        const res = await postData({ action: 'resetAll', password: sessionPass });
        alert(res.message);
        loadData();
    }
</script>
</body>
</html>
