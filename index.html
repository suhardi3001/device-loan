<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pinjaman Peranti</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
        .nav-tabs { margin-bottom: 20px; }
        #loading { display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; text-align: center; padding-top: 200px; }
        /* Style untuk butab disabled */
        button:disabled { cursor: not-allowed; opacity: 0.6; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-center">Sistem Pinjaman Peranti</h2>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#loan">Pinjam</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#return">Pulang</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin">Admin</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="loan">
            <form id="loanForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Nama Pengguna</label>
                        <input class="form-control" list="userList" id="userName" required placeholder="Cari nama...">
                        <datalist id="userList"></datalist>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Pilih Peranti</label>
                        <select class="form-select" id="deviceSelect" required>
                            <option value="" disabled selected>Sedang memuatkan...</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Tarikh Mula</label>
                        <input type="date" class="form-control" id="startDate" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Tarikh Tamat</label>
                        <input type="date" class="form-control" id="endDate" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label>Jenis Kegunaan</label>
                    <select class="form-select" id="usageType" required>
                        <option value="" disabled selected>Sila Pilih...</option>
                        <option value="Kegunaan Dalaman">Kegunaan Dalaman (Pejabat/Kampus)</option>
                        <option value="Kegunaan Luar">Kegunaan Luar (Remote/Field)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label>Butiran / Tujuan <span class="text-muted">(Pilihan)</span></label>
                    <textarea class="form-control" id="usageDetails" placeholder="Contoh: Mesyuarat Projek A"></textarea>
                </div>
                
                <button type="button" id="btnSubmitLoan" onclick="submitLoan()" class="btn btn-primary w-100" disabled>Hantar Permohonan</button>
            </form>
        </div>

        <div class="tab-pane fade" id="return">
            <div class="card bg-light border-primary p-3">
                <h5>Pulangkan Peranti</h5>
                <p class="small text-muted">Pilih peranti yang ingin dipulangkan dari senarai di bawah.</p>
                <select class="form-select mb-3" id="returnSelect">
                    <option value="" disabled selected>Sedang memuatkan...</option>
                </select>
                <button onclick="submitReturn()" class="btn btn-success w-100">Sahkan Pulangan</button>
            </div>
        </div>

        <div class="tab-pane fade" id="admin">
            <div id="loginPanel" class="text-center">
                <h4>Log Masuk Admin</h4>
                <div class="input-group mb-3">
                    <input type="password" id="adminPass" class="form-control" placeholder="Kata Laluan">
                    <button class="btn btn-dark" onclick="verifyAdmin()">Buka</button>
                </div>
            </div>
            <div id="adminPanel" style="display:none;">
                <div class="d-flex justify-content-between mb-3">
                    <h5 class="text-success">Akses Dibenarkan</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">Kunci Semula</button>
                </div>
                <div class="row g-2">
                    <div class="col-md-6 p-2 border rounded">
                        <h6>Tambah Pengguna</h6>
                        <input id="newUserName" class="form-control mb-2" placeholder="Nama Penuh">
                        <button onclick="addUser()" class="btn btn-sm btn-secondary w-100">Tambah</button>
                    </div>
                    <div class="col-md-6 p-2 border rounded">
                        <h6>Tambah Peranti</h6>
                        <input id="newTag" class="form-control mb-1" placeholder="Tag (Cth: NB-01)">
                        <select id="newType" class="form-select mb-1">
                            <option>Notebook</option><option>Projector</option><option>HDMI Cable</option><option>Webcam</option>
                        </select>
                        <input id="newSerial" class="form-control mb-1" placeholder="No. Siri">
                        <button onclick="addDevice()" class="btn btn-sm btn-secondary w-100">Tambah</button>
                    </div>
                </div>
                <hr>
                <button class="btn btn-danger w-100" onclick="resetAll()">âš  RESET SISTEM</button>
                <small class="text-danger d-block text-center mt-2">Ini akan menukar semua status kepada "Tersedia"</small>
            </div>
        </div>
    </div>
</div>

<div id="loading"><div class="spinner-border text-primary"></div><br>Sedang Memproses...</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // *** MASUKKAN URL DEPLOYMENT ANDA DI SINI (Pastikan akhiran /exec) ***
    const API_URL = "https://script.google.com/macros/s/AKfycbzm1Dwo6NSbMSs1nZT4K51J09UWff7QjriM93mYOpR8RUTReLEB5UwvjdvKmNiNvh8LZQ/exec";
    
    let sessionPass = "";

    window.onload = function() {
        loadData();
        setupValidation(); // Jalankan fungsi validasi
    };

    // --- LOGIK VALIDASI BUTANG ---
    function setupValidation() {
        const fields = ['userName', 'deviceSelect', 'startDate', 'endDate', 'usageType'];
        const btn = document.getElementById('btnSubmitLoan');

        fields.forEach(id => {
            const el = document.getElementById(id);
            // Semak setiap kali input berubah
            el.addEventListener('input', checkForm);
            el.addEventListener('change', checkForm);
        });

        function checkForm() {
            const user = document.getElementById('userName').value;
            const device = document.getElementById('deviceSelect').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const type = document.getElementById('usageType').value;

            // Jika semua ada nilai, buang disabled
            if(user && device && start && end && type) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }
    }

    async function loadData() {
        try {
            document.getElementById('loading').style.display = 'block';
            const res = await fetch(API_URL + "?action=getData");
            const data = await res.json();
            
            // 1. Senarai Pengguna
            const uList = document.getElementById('userList');
            uList.innerHTML = '';
            if(data.users) {
                data.users.forEach(u => {
                    let opt = document.createElement('option'); opt.value = u; uList.appendChild(opt);
                });
            }

            // 2. Peranti Tersedia (Pinjam)
            const dSel = document.getElementById('deviceSelect');
            dSel.innerHTML = '<option value="" disabled selected>Sila Pilih Peranti...</option>';
            if(data.inventory) {
                data.inventory.forEach(d => {
                    let opt = document.createElement('option');
                    opt.value = d[0]; opt.text = `${d[0]} | ${d[2]} | ${d[1]}`;
                    dSel.appendChild(opt);
                });
            }

            // 3. Peranti Dipinjam (Pulang)
            const rSel = document.getElementById('returnSelect');
            rSel.innerHTML = '<option value="" disabled selected>Pilih Peranti Dipinjam...</option>';
            if(data.loaned) {
                data.loaned.forEach(d => {
                    let opt = document.createElement('option');
                    opt.value = d[0]; opt.text = `${d[0]} | ${d[2]} | ${d[1]}`;
                    rSel.appendChild(opt);
                });
            }
            document.getElementById('loading').style.display = 'none';
        } catch (e) { 
            document.getElementById('loading').style.display = 'none';
            alert("Ralat Sambungan: " + e); 
        }
    }

    async function postData(payload) {
        document.getElementById('loading').style.display = 'block';
        try {
            const res = await fetch(API_URL, {
                method: "POST",
                redirect: "follow",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            document.getElementById('loading').style.display = 'none';
            return json;
        } catch (error) {
            document.getElementById('loading').style.display = 'none';
            alert("Ralat: " + error);
            return { status: "error", message: error };
        }
    }

    async function submitLoan() {
        const payload = {
            action: 'submitLoan',
            userName: document.getElementById('userName').value,
            deviceSelect: document.getElementById('deviceSelect').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            usageType: document.getElementById('usageType').value,
            usageDetails: document.getElementById('usageDetails').value
        };
        const res = await postData(payload);
        alert(res.message);
        // Reset borang dan disable butang semula
        document.getElementById('loanForm').reset();
        document.getElementById('btnSubmitLoan').disabled = true;
        loadData();
    }

    async function submitReturn() {
        const tag = document.getElementById('returnSelect').value;
        if(!tag) return alert("Sila pilih peranti dahulu.");
        
        const payload = { action: 'processReturn', assetTag: tag };
        const res = await postData(payload);
        alert(res.message);
        loadData();
    }

    async function verifyAdmin() {
        const pass = document.getElementById('adminPass').value;
        const res = await postData({ action: 'adminVerify', password: pass });
        if(res.valid) {
            sessionPass = pass;
            document.getElementById('loginPanel').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
        } else {
            alert("Kata Laluan Salah");
        }
    }

    async function addUser() {
        const name = document.getElementById('newUserName').value;
        if(!name) return alert("Sila masukkan nama");
        const res = await postData({ action: 'addUser', name: name, password: sessionPass });
        alert(res.message);
        document.getElementById('newUserName').value = '';
        loadData();
    }

    async function addDevice() {
        const tag = document.getElementById('newTag').value;
        const type = document.getElementById('newType').value;
        const serial = document.getElementById('newSerial').value;
        if(!tag || !serial) return alert("Sila isi semua maklumat");
        
        const res = await postData({ action: 'addDevice', tag: tag, type: type, serial: serial, password: sessionPass });
        alert(res.message);
        document.getElementById('newTag').value = '';
        document.getElementById('newSerial').value = '';
        loadData();
    }

    async function resetAll() {
        if(!confirm("Adakah anda pasti? Ini akan menukar status semua peranti kepada 'Tersedia'.")) return;
        const res = await postData({ action: 'resetAll', password: sessionPass });
        alert(res.message);
        loadData();
    }
</script>
</body>
</html>
